/*
insert license info here
*/
using System;
using System.Collections;
using NHibernate;
using NHibernate.Expression;
using System.Data;
using System.Data.SqlClient;

namespace Business.Data.Laboratorio
{
	/// <summary>
	///	Generated by MyGeneration using the NHibernate Object Mapping template
	/// </summary>
	[Serializable]
    public sealed class DetalleProtocolo : Business.BaseDataAccess
	{

		#region Private Members
		private bool m_isChanged;

		private int m_iddetalleprotocolo; 
		private Protocolo m_idprotocolo; 
		private Efector m_idefector; 
		private Item m_iditem;
        private Item m_idsubitem; 
		private string m_resultadocar; 
		private decimal m_resultadonum;
        private string m_trajomuestra;
        private string m_codigoobservaciones;
		private string m_observaciones;
        private string m_unidadmedida;
        private string m_metodo;
        private string m_valorreferencia; 
        private bool m_conresultado;
		private int m_idusuarioresultado; 
		private DateTime m_fecharesultado; 
		private int m_idusuariovalida; 
		private DateTime m_fechavalida;
        private int m_idusuariocontrol;
        private DateTime m_fechacontrol;
        private int m_idusuarioimpresion;
        private DateTime m_fechaimpresion;
        private int m_enviado;
        private int m_idusuarioenvio;
        private DateTime m_fechaenvio;

        private int m_idusuarioobservacion;
        private DateTime m_fechaobservacion;

        private int m_idusuariovalidaobservacion;
        private DateTime m_fechavalidaobservacion;
        private int m_formatovalida;
		#endregion

		#region Default ( Empty ) Class Constuctor
		/// <summary>
		/// default constructor
		/// </summary>
		public DetalleProtocolo()
		{
			m_iddetalleprotocolo = 0; 
			m_idprotocolo = new Protocolo(); 
			m_idefector = new Efector(); 
			m_iditem = new Item();
            m_idsubitem = new Item();
			m_resultadocar = String.Empty; 
			m_resultadonum = 0;
            m_unidadmedida = String.Empty;
            m_metodo = String.Empty;
            m_valorreferencia = String.Empty; 
            m_trajomuestra = String.Empty;
            m_codigoobservaciones = String.Empty;
			m_observaciones = String.Empty;
            m_conresultado = false; 
			m_idusuarioresultado = 0; 
			m_fecharesultado = DateTime.MinValue; 
			m_idusuariovalida = 0; 
			m_fechavalida = DateTime.MinValue;
            m_idusuariocontrol = 0;
            m_fechacontrol = DateTime.MinValue;
            m_idusuarioimpresion = 0;
            m_fechaimpresion = DateTime.MinValue;
            m_enviado = 0;
            m_idusuarioenvio = 0;
            m_fechaenvio = DateTime.MinValue;

            m_idusuarioobservacion = 0;
            m_fechaobservacion = DateTime.MinValue;
            
            m_idusuariovalidaobservacion= 0;
            m_fechavalidaobservacion = DateTime.MinValue;
            m_formatovalida = 0;

		}
		#endregion // End of Default ( Empty ) Class Constuctor

		#region Required Fields Only Constructor
		/// <summary>
		/// required (not null) fields only constructor
		/// </summary>
		public DetalleProtocolo(
			Protocolo idprotocolo, 
			Efector idefector, 
			Item iditem, 
            Item idsubitem,
            string trajomuestra,
			bool conresultado,
			int idusuarioresultado, 
			DateTime fecharesultado, 
			int idusuariovalida, 
			DateTime fechavalida,
            int idusuariocontrol,
            DateTime fechacontrol,
              int idusuarioimpresion,
            DateTime fechaimpresion
            //int idusuarioenvio,
            //DateTime fechaenvio
            )
			: this()
		{
			m_idprotocolo = idprotocolo;
			m_idefector = idefector;
			m_iditem = iditem;
            m_idsubitem = idsubitem;			
            m_trajomuestra = trajomuestra;
			m_observaciones = String.Empty;
			m_idusuarioresultado = idusuarioresultado;
			m_fecharesultado = fecharesultado;
			m_idusuariovalida = idusuariovalida;
			m_fechavalida = fechavalida;
            m_conresultado = conresultado;
            m_idusuariocontrol = idusuariocontrol;
            m_fechacontrol= fechacontrol;
            m_idusuariocontrol = idusuarioimpresion;
            m_fechacontrol = fechaimpresion;
            //m_idusuarioenvio = idusuarioenvio;
            //m_fechaenvio = fechaenvio;

            
		}
		#endregion // End Required Fields Only Constructor

		#region Public Properties
			
		/// <summary>
		/// 
		/// </summary>
		public int IdDetalleProtocolo
		{
			get { return m_iddetalleprotocolo; }
			set
			{
				m_isChanged |= ( m_iddetalleprotocolo != value ); 
				m_iddetalleprotocolo = value;
			}

		}
        public int FormatoValida
        {
            get { return m_formatovalida; }
            set
            {
                m_isChanged |= (m_formatovalida != value);
                m_formatovalida = value;
            }

        }
		/// <summary>
		/// 
		/// </summary>
		public Protocolo IdProtocolo
		{
			get { return m_idprotocolo; }
			set
			{
				m_isChanged |= ( m_idprotocolo != value ); 
				m_idprotocolo = value;
			}

		}
			
		/// <summary>
		/// 
		/// </summary>
		public Efector IdEfector
		{
			get { return m_idefector; }
			set
			{
				m_isChanged |= ( m_idefector != value ); 
				m_idefector = value;
			}

		}
			
		/// <summary>
		/// 
		/// </summary>
		public Item IdItem
		{
			get { return m_iditem; }
			set
			{
				m_isChanged |= ( m_iditem != value ); 
				m_iditem = value;
			}

		}

        /// <summary>
        /// 
        /// </summary>
        public Item IdSubItem
        {
            get { return m_idsubitem; }
            set
            {
                m_isChanged |= (m_idsubitem != value);
                m_idsubitem = value;
            }

        }
		/// <summary>
		/// 
		/// </summary>
        public string ResultadoCar
        {
            get { return m_resultadocar; }

            set
            {
                if (value != null && value.Length > 500)
                    throw new ArgumentOutOfRangeException("Invalid value for m_resultadocar", value, value.ToString());

                m_isChanged |= (m_resultadocar != value); m_resultadocar = value;
            }
        }
		/// <summary>
		/// 
		/// </summary>
		public decimal ResultadoNum
		{
			get { return m_resultadonum; }
			set
			{
				m_isChanged |= ( m_resultadonum != value ); 
				m_resultadonum = value;
			}

		}

        public string UnidadMedida
        {
            get { return m_unidadmedida; }

            set
            {
                if (value != null && value.Length > 200)
                    throw new ArgumentOutOfRangeException("Invalid value for m_unidadmedida", value, value.ToString());

                m_isChanged |= (m_unidadmedida != value); m_unidadmedida = value;
            }
        }

        public string Metodo
        {
            get { return m_metodo; }

            set
            {
                if (value == null)
                    throw new ArgumentOutOfRangeException("Null value not allowed for Metodo", value, "null");

                if (value.Length > 100)
                    throw new ArgumentOutOfRangeException("Invalid value for Metodo", value, value.ToString());

                m_isChanged |= (m_metodo != value); m_metodo = value;
            }
        }

        /// <summary>
        /// 
        /// </summary>
        public string ValorReferencia
        {
            get { return m_valorreferencia; }

            set
            {
                if (value == null)
                    throw new ArgumentOutOfRangeException("Null value not allowed for ValorReferencia", value, "null");

                if (value.Length > 500)
                    throw new ArgumentOutOfRangeException("Invalid value for ValorReferencia", value, value.ToString());

                m_isChanged |= (m_valorreferencia != value); m_valorreferencia = value;
            }
        }
			
        /// <summary>
        /// 
        /// </summary>
        public string TrajoMuestra
        {
            get { return m_trajomuestra; }

            set
            {
                if (value != null && value.Length > 2)
                    throw new ArgumentOutOfRangeException("Invalid value for m_trajomuestra", value, value.ToString());

                m_isChanged |= (m_trajomuestra != value); m_trajomuestra = value;
            }
        }


        /// </summary>
        public string CodigoObservaciones
        {
            get { return m_codigoobservaciones; }

            set
            {
                if (value != null && value.Length > 10)
                    throw new ArgumentOutOfRangeException("Invalid value for m_codigoobservaciones", value, value.ToString());

                m_isChanged |= (m_codigoobservaciones != value); m_codigoobservaciones = value;
            }
        }
		/// <summary>
		/// 
		/// </summary>
		public string Observaciones
		{
			get { return m_observaciones; }

			set	
			{	
				if(  value != null &&  value.Length > 4000)
					throw new ArgumentOutOfRangeException("Invalid value for Observaciones", value, value.ToString());
				
				m_isChanged |= (m_observaciones != value); m_observaciones = value;
			}
		}
			
		/// <summary>
		/// 
		/// </summary>
		public int IdUsuarioResultado
		{
			get { return m_idusuarioresultado; }
			set
			{
				m_isChanged |= ( m_idusuarioresultado != value ); 
				m_idusuarioresultado = value;
			}

		}
			
		/// <summary>
		/// 
		/// </summary>
		public DateTime FechaResultado
		{
			get { return m_fecharesultado; }
			set
			{
				m_isChanged |= ( m_fecharesultado != value ); 
				m_fecharesultado = value;
			}

		}
        /// <summary>
        /// 
        /// </summary>
        public bool ConResultado
        {
            get { return m_conresultado; }
            set
            {
                m_isChanged |= (m_conresultado != value);
                m_conresultado = value;
            }

        }
		/// <summary>
		/// 
		/// </summary>
		public int IdUsuarioValida
		{
			get { return m_idusuariovalida; }
			set
			{
				m_isChanged |= ( m_idusuariovalida != value ); 
				m_idusuariovalida = value;
			}

		}
			
		/// <summary>
		/// 
		/// </summary>
		public DateTime FechaValida
		{
			get { return m_fechavalida; }
			set
			{
				m_isChanged |= ( m_fechavalida != value ); 
				m_fechavalida = value;
			}

		}

        /// <summary>
        /// 
        /// </summary>
        public int IdUsuarioControl
        {
            get { return m_idusuariocontrol; }
            set
            {
                m_isChanged |= (m_idusuariocontrol != value);
                m_idusuariocontrol = value;
            }

        }

        /// <summary>
        /// 
        /// </summary>
        public DateTime FechaControl
        {
            get { return m_fechacontrol; }
            set
            {
                m_isChanged |= (m_fechacontrol != value);
                m_fechacontrol = value;
            }

        }


        /// <summary>
        /// 
        /// </summary>
        public int IdUsuarioImpresion
        {
            get { return m_idusuarioimpresion; }
            set
            {
                m_isChanged |= (m_idusuarioimpresion != value);
                m_idusuarioimpresion = value;
            }

        }

        /// <summary>
        /// 
        /// </summary>
        public DateTime FechaImpresion
        {
            get { return m_fechaimpresion; }
            set
            {
                m_isChanged |= (m_fechaimpresion != value);
                m_fechaimpresion = value;
            }

        }


        public int Enviado
        {
            get { return m_enviado; }
            set
            {
                m_isChanged |= (m_enviado != value);
                m_enviado = value;
            }

        }


        public int IdUsuarioEnvio
        {

            get { return m_idusuarioenvio; }
            set
            {
                m_isChanged |= (m_idusuarioenvio != value);
                m_idusuarioenvio = value;
            }

        }

        /// <summary>
        /// 
        /// </summary>
        public DateTime FechaEnvio
        {

            get { return m_fechaenvio; }
            set
            {
                m_isChanged |= (m_fechaenvio != value);
                m_fechaenvio = value;
            }

        }


        public int IdUsuarioObservacion
        {

            get { return m_idusuarioobservacion; }
            set
            {
                m_isChanged |= (m_idusuarioobservacion != value);
                m_idusuarioobservacion = value;
            }

        }

        /// <summary>
        /// 
        /// </summary>
        public DateTime FechaObservacion
        {

            get { return m_fechaobservacion; }
            set
            {
                m_isChanged |= (m_fechaobservacion != value);
                m_fechaobservacion = value;
            }

        }


        public int IdUsuarioValidaObservacion
        {

            get { return m_idusuariovalidaobservacion; }
            set
            {
                m_isChanged |= (m_idusuariovalidaobservacion != value);
                m_idusuariovalidaobservacion = value;
            }

        }

        /// <summary>
        /// 
        /// </summary>
        public DateTime FechaValidaObservacion
        {

            get { return m_fechavalidaobservacion; }
            set
            {
                m_isChanged |= (m_fechavalidaobservacion != value);
                m_fechavalidaobservacion = value;
            }

        }

		/// <summary>
		/// Returns whether or not the object has changed it's values.
		/// </summary>
		public bool IsChanged
		{
			get { return m_isChanged; }
		}
				
		#endregion 


        ///Metodos
        ///


        public string CalcularValoresReferencia()
        {
            int edadPaciente= IdProtocolo.Edad;
            string valorReferencia = "";
            
            switch( IdProtocolo.UnidadEdad)  ///lleva las edades a dias
            {
                case 0: /// años
                   edadPaciente= IdProtocolo.Edad * 365; break;
                case 1: /// meses
                   edadPaciente= IdProtocolo.Edad * 30; break;               
            }
            
            ISession m_session = NHibernateHttpModule.CurrentSession;
            ICriteria crit = m_session.CreateCriteria(typeof(ValorReferencia));
            crit.Add(Expression.Eq("IdItem", IdSubItem));
                                                   
            IList detalle = crit.List();
            string s_metodo = "";
                if (detalle.Count > 0)
                {
                    foreach (ValorReferencia oDetalle in detalle)
                    {
                        int edadDesde = oDetalle.EdadDesde;
                        int edadHasta = oDetalle.EdadHasta;
                        switch (oDetalle.UnidadEdad)
                        {
                            case 0: /// años
                                { edadDesde = edadDesde * 365;
                                edadHasta = edadHasta * 365; 
                                } break;
                            case 1: /// meses
                                {
                                    edadDesde = edadDesde * 30; 
                                         edadHasta = edadHasta * 30;                                       
                                }
                        break;                           
                        }
                        if ((IdProtocolo.Sexo == oDetalle.Sexo) || (oDetalle.Sexo == "I")) // coincide el sexo del paciente o el sexo del valor de referencia es Indistinto
                        {
                            if ((edadPaciente >= edadDesde) && (edadPaciente <= edadHasta)) // si la edad del paciente está entre los rangos definidos.
                            {
                                string s_valorminimo =Math.Round( oDetalle.ValorMinimo, oDetalle.IdItem.FormatoDecimal).ToString(System.Globalization.CultureInfo.InvariantCulture);
                                string s_valormaximo = Math.Round(oDetalle.ValorMaximo, oDetalle.IdItem.FormatoDecimal).ToString(System.Globalization.CultureInfo.InvariantCulture);                                    
                                if (valorReferencia != "")
                                    valorReferencia += Environment.NewLine;
                                switch (oDetalle.TipoValor)
                                {
                                    case 0:
                                        //valorReferencia += s_valorminimo + " a " + s_valormaximo + Environment.NewLine+ oDetalle.Observacion ;
                                        valorReferencia += s_valorminimo + " a " + s_valormaximo + " "  + oDetalle.Observacion;
                                        break;
                                    case 1:
                                        //valorReferencia += "Mayor de:" + s_valorminimo + Environment.NewLine + oDetalle.Observacion;
                                        valorReferencia += "Mayor de:" + s_valorminimo + " " + oDetalle.Observacion;
                                        break;
                                    case 2:
                                        //valorReferencia += "Hasta:" + s_valormaximo + Environment.NewLine + oDetalle.Observacion;
                                        valorReferencia += "Hasta:" + s_valormaximo + " " + oDetalle.Observacion;
                                        break;
                                    case 3:
                                        valorReferencia += oDetalle.Observacion;
                                        break;

                                }
                                
                                if (oDetalle.IdMetodo != 0)
                                {
                                    Metodo oMetodo = new Metodo();
                                    oMetodo = (Metodo)oMetodo.Get(typeof(Metodo), oDetalle.IdMetodo);
                                    s_metodo = oMetodo.Nombre;
                                    //valorReferencia +=Environment.NewLine+ " |Método:" + oMetodo.Nombre;
                                }
                            //    break;
                            }
                        }
                    }//foreach
                }

                if (s_metodo != "")
                {
                    valorReferencia += Environment.NewLine + " |Método:" + s_metodo;
                }
                return valorReferencia;
       

            
        }


        public bool VerificaValoresLimites(decimal x)
        {
            bool devolver = false;

            if (this.IdSubItem.ValorMaximo != -1)
            {
                if (x > this.IdSubItem.ValorMaximo)
                    devolver = true;
                else
                {
                    if (this.IdSubItem.ValorMinimo != -1)
                    {
                        if (x < this.IdSubItem.ValorMinimo)
                            devolver = true;
                        else devolver = false;
                    }
                }
            }
            return devolver;

        }
        public bool VerificaValorReferencia(decimal x)
        {
            bool devolver = true;
          
            int edadPaciente= IdProtocolo.Edad;                      
            switch( IdProtocolo.UnidadEdad)  ///lleva las edades a dias
            {
                case 0: /// años
                   edadPaciente= IdProtocolo.Edad * 365; break;
                case 1: /// meses
                   edadPaciente= IdProtocolo.Edad * 30; break;               
            }
            
            ISession m_session = NHibernateHttpModule.CurrentSession;
            ICriteria crit = m_session.CreateCriteria(typeof(ValorReferencia));
            crit.Add(Expression.Eq("IdItem", IdSubItem));
                                                   
            IList detalle = crit.List();

            if (detalle.Count > 0)
            {
                foreach (ValorReferencia oDetalle in detalle)
                {
                    int edadDesde = oDetalle.EdadDesde;
                    int edadHasta = oDetalle.EdadHasta;
                    switch (oDetalle.UnidadEdad)
                    {
                        case 0: /// años
                            {
                                edadDesde = edadDesde * 365;
                                edadHasta = edadHasta * 365;
                            } break;
                        case 1: /// meses
                            {
                                edadDesde = edadDesde * 30;
                                edadHasta = edadHasta * 30;
                            }
                            break;
                    }
                    if ((IdProtocolo.Sexo == oDetalle.Sexo) || (oDetalle.Sexo == "I")) // coincide el sexo del paciente o el sexo del valor de referencia es Indistinto
                    {
                        if ((edadPaciente >= edadDesde) && (edadPaciente <= edadHasta)) // si la edad del paciente está entre los rangos definidos.
                        {

                            switch (oDetalle.TipoValor)
                            {
                                case 0: //rango de valores
                                    if ((x >= oDetalle.ValorMinimo) && (x <= oDetalle.ValorMaximo)) devolver = true;
                                    else devolver = false;
                                    break;

                                case 1: //con valor minimo solamente
                                    if (x >= oDetalle.ValorMinimo) devolver = true;
                                    else devolver = false;
                                    break;
                                case 2: //con valor maximo solamente
                                    if (x <= oDetalle.ValorMaximo) devolver = true;
                                    else devolver = false;
                                    break;
                                case 3:
                                    devolver = true; break;

                            }
                        }
                    }

                }/// for each
            } // if 
            return devolver;
            
        }


        public string BuscarResultadoAnterior(Item subitem, Item itemprincipal, bool conFecha)
        {            
            string s_resultadoAnterior = "";
            string s_idPaciente = this.IdProtocolo.IdPaciente.IdPaciente.ToString();
       //     int s_idSubItem = this.IdSubItem.IdItem;
            string s_idProtocoloActual =  this.IdProtocolo.IdProtocolo.ToString();
            
            //DataSet Ds = new DataSet();
            //SqlConnection conn = (SqlConnection)NHibernateHttpModule.CurrentSession.Connection;
            //SqlCommand cmd = new SqlCommand();
            //cmd.CommandType = CommandType.StoredProcedure;

            //cmd.CommandText = "LAB_ResultadoAnterior";
           

            /////////Parametro hoja de trabajo
            //cmd.Parameters.Add("@idProtocolo", SqlDbType.Int);
            //cmd.Parameters["@idProtocolo"].Value = int.Parse(s_idProtocoloActual);
            

            /////////Parametro @idEfectorSolicitante
            //cmd.Parameters.Add("@idPaciente", SqlDbType.Int);
            //cmd.Parameters["@idPaciente"].Value = int.Parse(s_idPaciente);

            /////////Parametro @@idOrigen
            //cmd.Parameters.Add("@idItem", SqlDbType.Int);
            //cmd.Parameters["@idItem"].Value = itemprincipal.IdItem;

            /////////Parametro @@@idPrioridad
            //cmd.Parameters.Add("@idSubItem", SqlDbType.Int);
            //cmd.Parameters["@idSubItem"].Value = subitem.IdItem;

            //cmd.Connection = conn;

            //SqlDataAdapter da = new SqlDataAdapter(cmd);

            //da.Fill(Ds);
            //if (Ds.Tables[0].Rows.Count > 0)
            //    s_resultadoAnterior = Ds.Tables[0].Rows[0][0].ToString() + Environment.NewLine + Ds.Tables[0].Rows[0][1].ToString();

            ICriteria critProtocolo = m_session.CreateCriteria(typeof(Protocolo));

            string ssql_Protocolo = " IdProtocolo in (Select top 10 LAb_Protocolo.IdProtocolo From LAb_Protocolo where LAb_Protocolo.baja=0 and LAb_Protocolo.estado>0 and LAb_Protocolo.idPaciente=" + s_idPaciente + " and LAb_Protocolo.IdProtocolo<" + s_idProtocoloActual + " order by LAb_Protocolo.IdProtocolo desc )";
            critProtocolo.Add(Expression.Sql(ssql_Protocolo));
            //Protocolo oUltimoProtocolo = (Protocolo)critProtocolo.List;

            IList detalle = critProtocolo.List();

            if (detalle.Count > 0)
            {
                foreach (Protocolo oDetalle in detalle)

                //if (oUltimoProtocolo != null)
                {

                    ICriteria crit = m_session.CreateCriteria(typeof(DetalleProtocolo));
                    crit.Add(Expression.Eq("IdItem", itemprincipal));
                    crit.Add(Expression.Eq("IdSubItem", subitem));
                    crit.Add(Expression.Eq("IdProtocolo", oDetalle));
                    DetalleProtocolo oUltimoResultado = (DetalleProtocolo)crit.UniqueResult();

                    if (oUltimoResultado != null)
                    {
                        Utility oUtil = new Utility();
                        if ((oUltimoResultado.IdUsuarioValida > 0) &&(oUltimoResultado.ConResultado))
                        {
                            //if (oUltimoResultado.IdSubItem.IdTipoResultado == 1)
                            if (oUltimoResultado.ResultadoCar.Trim()=="")
                            {
                                decimal resultadoAnterior = oUltimoResultado.ResultadoNum;
                                //string formato = oUtil.Formato(subitem.FormatoDecimal.ToString());
                                string formato = oUtil.Formato(oUltimoResultado.FormatoValida.ToString());
                                decimal x = decimal.Parse(resultadoAnterior.ToString(formato));
                                s_resultadoAnterior = x.ToString(System.Globalization.CultureInfo.InvariantCulture) +" " + oUltimoResultado.UnidadMedida;
                            }
                            else
                            {
                                s_resultadoAnterior = oUltimoResultado.ResultadoCar;
                                if (s_resultadoAnterior.Length>10)
                                    s_resultadoAnterior = s_resultadoAnterior.Substring(0, 10);
                               
                            }
                            if (conFecha) s_resultadoAnterior =s_resultadoAnterior +Environment.NewLine + oUltimoResultado.IdProtocolo.Fecha.ToShortDateString();
                            break;
                        }
                        //else
                        //  s_resultadoAnterior = "";
                    }
                }
            }
            return s_resultadoAnterior;

        }


        public void GrabarAuditoriaDetalleProtocolo(string m_accion, int m_idusuario)
        {
            AuditoriaProtocolo oRegistro = new AuditoriaProtocolo();
            oRegistro.Accion = m_accion;
            oRegistro.Fecha = DateTime.Now;
            oRegistro.Hora = DateTime.Now.ToLongTimeString();
            oRegistro.IdProtocolo = this.IdProtocolo.IdProtocolo;
            oRegistro.IdUsuario = m_idusuario;
            oRegistro.Analisis = this.IdSubItem.Nombre;
            if (IdSubItem.IdTipoResultado == 1)
                if (this.ConResultado)
                    oRegistro.Valor = this.ResultadoNum.ToString();
                else
                    oRegistro.Valor = "";
            else
                oRegistro.Valor = this.ResultadoCar;
            
            oRegistro.Save();
        }

        public void GrabarAuditoriaDetalleObservacionesProtocolo(string m_accion, int m_idusuario)
        {
            AuditoriaProtocolo oRegistro = new AuditoriaProtocolo();
            oRegistro.Accion = m_accion;
            oRegistro.Fecha = DateTime.Now;
            oRegistro.Hora = DateTime.Now.ToLongTimeString();
            oRegistro.IdProtocolo = this.IdProtocolo.IdProtocolo;
            oRegistro.IdUsuario = m_idusuario;
            oRegistro.Analisis = this.IdSubItem.Nombre+" - Observacion";
            oRegistro.Valor = this.Observaciones;

            oRegistro.Save();
        }


        public bool AnalizarLimites(string p)
        {
            string[] arr = p.Split((",").ToCharArray());

            foreach (string m in arr)
            {
                if (this.IdDetalleProtocolo.ToString() == m)
                    return false;
            }
            return true;
        }

        public string getUsuarioOperacion(string operacion)
        {
            string valor = ""; int idusuario = 0;
            switch (operacion)
            {
                case "Carga":{ if (this.IdUsuarioResultado>0) idusuario = this.IdUsuarioResultado; }break;
                case "Control": 
                    { if (this.IdUsuarioControl>0)
                        idusuario = this.IdUsuarioControl; 
                    }
                    break;
                case "Valida":
                    {
                        if (this.IdUsuarioValida > 0)

                            idusuario = this.IdUsuarioValida;
                        if (this.IdUsuarioValidaObservacion > 0)
                            idusuario = this.IdUsuarioValidaObservacion;
                    }
                    break;

            
            }
            if (idusuario > 0)
            {
                Usuario oUser = new Usuario();
                oUser = (Usuario)oUser.Get(typeof(Usuario), idusuario);
                if (oUser != null) valor = oUser.Apellido + oUser.Nombre;
            }
            return valor;
                    
        }
    }
}
